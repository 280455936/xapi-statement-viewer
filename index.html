<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="initial-scale=1.0, maximum-scale=2.0">

	<title>xAPI Statement Viewer</title>
	<link rel="stylesheet" type="text/css" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css">
	<link rel="stylesheet" type="text/css" href="http://cdn.datatables.net/plug-ins/f2c75b7247b/integration/bootstrap/3/dataTables.bootstrap.css">
  <link rel="stylesheet" type="text/css" href="css/bootstrap-datetimepicker.min.css" />
  <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/prettify/r298/prettify.min.css" />
  <link rel="stylesheet" type="text/css" href="css/styles.css" />

	<script type="text/javascript" language="javascript" src="js/jquery.js"></script>
	<script type="text/javascript" language="javascript" src="js/jquery.dataTables.min.js"></script>
	<script type="text/javascript" language="javascript" src="js/jquery.cookie.js"></script>
	<script type="text/javascript" language="javascript" src="http://cdn.datatables.net/plug-ins/f2c75b7247b/integration/bootstrap/3/dataTables.bootstrap.js"></script>
	<script type="text/javascript" language="javascript" src="js/transition.js"></script>
	<script type="text/javascript" language="javascript" src="js/collapse.js"></script>
  <script type="text/javascript" language="javascript" src="https://cdnjs.cloudflare.com/ajax/libs/prettify/r298/prettify.min.js"></script>
  <script type="text/javascript" language="javascript" src="js/moment.min.js"></script>
  <script type="text/javascript" language="javascript" src="js/bootstrap-datetimepicker.min.js"></script>
  <script type="text/javascript" language="javascript" src="js/cryptojs_v3.1.2.min.js"></script>
  <script type="text/javascript" language="javascript" src="js/xapiwrapper.min.js"></script>
	<script type="text/javascript" language="javascript" class="init">
    var conf = {
      "endpoint" : "https://lrs.adlnet.gov/xapi/",
      "auth" : "Basic " + toBase64("xapi-tools" + ":" + "xapi-tools"),
    };
    ADL.XAPIWrapper.changeConfig(conf);

    gmore = null;

    // Retreive statements from the LRS
    function getStatementsWithSearch(more) {
        var verbSort = $("#search-verb-sort").val();
        var verbId = $("#search-user-verb-id").val();
        var actorEmail = $("#search-actor-email").val();
        var activityId = $("#search-activity-id").val();
        var registrationId = $("#search-registration-id").val();
        var sinceDate = $("#search-statements-since-date input").val();
        var untilDate = $("#search-statements-until-date input").val();
        var limit = $("#search-limit").val();

        // Build Search
        var search = ADL.XAPIWrapper.searchParams();
        if (verbId != "") { search['verb'] = verbId; }
        if (verbSort != "") { search['ascending'] = verbSort; }
        if (actorEmail != "") { search['agent'] = JSON.stringify({ "mbox": "mailto:" + actorEmail}); }
        if (activityId != "") { search['activity'] = activityId; }
        if (registrationId != "") { search['registration'] = registrationId; }
        if (sinceDate != "") { search['since'] = sinceDate; }
        if (untilDate != "") { search['until'] = untilDate; }
        if (limit != "") { search['limit'] = limit; }
        //console.log(search);

        // Put together the xAPI Query
        var urlparams = new Array();
        var url = "https://lrs.adlnet.gov/xapi/statements";

        for (s in search)
        {
            urlparams.push(s + "=" + encodeURIComponent(search[s]));
        }
        if (urlparams.length > 0)
            url = url + "?" + urlparams.join("&");

        //console.log(url);
        $("#xapi-query").val(url);

        ADL.XAPIWrapper.getStatements(search, more, function(r) {
            //console.log(r);
            var response = $.parseJSON(r.response);

            // update the status in the HTML
            if (r.status == 200) {
              if (response.more != "") {
                gmore = response.more;
              } else {
                gmore = null;
              }
              console.log(gmore);
              stmts = $.parseJSON(JSON.stringify(response.statements));
              $('#statement-list').DataTable().rows.add(stmts).draw().nodes().to$();
              prettyPrint();
            }
        });
    }

    /* Formatting function for row details - modify as you need */
    function format ( d ) {
      // `d` is the original data object for the row
      return '<div><pre class="prettyprint lang-js">'+
      JSON.stringify(d, null, 2)+
      '</pre></div>';
    }

    $(document).ready(function() {
      var table = $('#statement-list').DataTable({
        "columns": [
          { data: "timestamp", "defaultContent": "" },
          { data: "actor.name", "defaultContent": "" },
          { data: "verb.display.en-US", "defaultContent": "" },
          { data: "object.definition.name.en-US", "defaultContent": "" },
          { data: "object.objectType", "defaultContent": "" },
          { data: "authority.name", "defaultContent": "" },
            {
              "className":      'details-control',
              "orderable":      false,
              "data":           null,
              "defaultContent": ''
            }
          ],
          "rowCallback": function( row, data ) {
            var display = moment(data.timestamp);
            $('td:eq(0)', row).html( '<span title="' + data.timestamp + '">' + display.fromNow() + '</span>' );
          },
          "order": [[0, 'desc']],
          "pageLength": 25
      });
       
      // Add event listener for opening and closing details
      $('#statement-list tbody').on('click', 'td.details-control', function () {
          var tr = $(this).closest('tr');
          var row = table.row( tr );

          if ( row.child.isShown() ) {
            // This row is already open - close it
            row.child.hide();
            tr.removeClass('shown');
          }
          else {
            // Open this row
            row.child( format(row.data()) ).show();
            tr.addClass('shown');
            PR.prettyPrint();
          }
      });

      // save panel state
      $("#query-options").on('shown.bs.collapse', function () {
          var active = $("#query-options.in").attr('id');
          $.cookie('activePanel', active);
      });
      $("#query-options").on('hidden.bs.collapse', function () {
          $.removeCookie('activePanel');
      });
      var last = $.cookie('activePanel');
      if (last != null) {
          $("#query-options.panel-collapse").removeClass('in');
          $("#" + last).addClass("in");
      }

      $(".collapser a").click(function (e) { e.preventDefault(); });

      $("#more").click(function(e) {
        if (gmore != null) {
          getStatementsWithSearch(gmore);
        } else {
          alert("no more!");
        }
        e.preventDefault();
      });

      // Populate the predefined verbs dropdown
      for (var key in ADL.verbs) {
          var $options = $("#search-predefined-verb");
          if (ADL.verbs.hasOwnProperty(key)) {
              $options.append($("<option />").val(ADL.verbs[key]['id']).text(ADL.verbs[key]['display']['en-US']));
          }
      }

      $('#search-statements-since-date').datetimepicker();
      $('#search-statements-until-date').datetimepicker();

      $("#search-predefined-verb").change(function() {
          var $this = $(this);
          $("#search-user-verb-id").val($this.val());
      });

      $("#get-statements-with-search").click(function(e) {
          $('#statement-list').DataTable().clear();
          getStatementsWithSearch(null);
          e.preventDefault();
      });
      
      // Populate the table
      getStatementsWithSearch(null);

    });
  </script>
</head>

<body>

  <section class="container">

    <div class="page-header">
      <h1 class="text-primary"><i class="glyphicon glyphicon-list-alt"></i> xAPI Statement Viewer</h1>
    </div>


    <div class="panel panel-info">
      <div class="panel-heading collapser">
        <h4 class="panel-title"><a data-toggle="collapse" data-target="#query-options" href="#query-options" class="collapsed">Query Options</a></h4>
      </div>
      <div id="query-options" class="panel-collapse collapse">
        <div class="panel-body">

          <div class="row">

            <div class="form-group col-md-6">
              <label for="search-predefined-verb">Predefined Verb</label>
              <select class="form-control" name="search-predefined-verb" id="search-predefined-verb">
                <option></option>
              </select>
            </div>
            <div class="form-group col-md-6">
              <label for="search-verb-sort">Verb Sort</label>
              <select class="form-control" name="search-verb-sort" id="search-verb-sort">
                <option value="">Descending</option>
                <option value="true">Ascending</option>
              </select>
            </div>

          </div><!-- .row -->

          <div class="row">

            <div class="form-group col-md-12">
              <label for="search-user-verb-id">Verb ID</label>
              <input type="text" class="form-control" value="" aria-describedby="Verb ID" placeholder="http://adlnet.gov/verbs/answered" id="search-user-verb-id" />
            </div>

          </div><!-- .row -->

          <div class="row">

            <div class="form-group col-md-12">
              <label for="search-actor-email">Actor Email</label>
              <input type="text" class="form-control" value="" aria-describedby="Agent" placeholder="tyler.mulligan.ctr@adlnet.gov" id="search-actor-email" />
            </div>

          </div><!-- .row -->

          <div class="row">

            <div class="form-group col-md-12">
              <label for="search-activity-id">Activity ID</label>
              <input type="text" class="form-control" value="" aria-describedby="Activity ID" placeholder="http://adlnet.gov/activities/question" id="search-activity-id" />
            </div>

          </div><!-- .row -->

          <div class="row">

            <div class="form-group col-md-12">
              <label for="search-registration-id">Registration ID</label>
              <input type="text" class="form-control" value="" aria-describedby="Registration ID" placeholder="51a6f860-1997-11e3-8ffd-0800200c9a66" id="search-registration-id" />
            </div>

          </div><!-- .row -->

          <div class="row">

            <div class="form-group col-md-6">
              <label for="search-statements-since-date">Since Date</label>
              <div class="input-group date" id="search-statements-since-date">
                <input type="text" class="form-control" />
                <span class="input-group-addon">
                  <span class="glyphicon glyphicon-calendar"></span>
                </span>
              </div>
            </div>

            <div class="form-group col-md-6">
              <label for="search-statements-until-date">Until Date</label>
              <div class="input-group date" id="search-statements-until-date">
                <input type="text" class="form-control" />
                <span class="input-group-addon">
                  <span class="glyphicon glyphicon-calendar"></span>
                </span>
              </div>
            </div>

          </div><!-- .row -->

          <div class="row">

            <div class="form-group col-md-12">
              <label for="search-limit">Limit</label>
              <input type="text" class="form-control" value="" aria-describedby="Limit" placeholder="25" id="search-limit" />
            </div>

          </div><!-- .row -->

          <div class="row">

            <div class="form-group col-md-12">
              <label for="xapi-query">xAPI Query</label>
              <input type="text" class="form-control" value="" aria-describedby="xAPI Query" id="xapi-query" readonly />
            </div>

          </div><!-- .row -->

        </div><!-- .panel-body -->
      </div><!-- #query-options -->
    </div><!-- .panel -->

    <p>
      <a class="btn btn-primary" href="#" role="button" id="get-statements-with-search">Get Statements <i class="glyphicon glyphicon-cloud-download"></i></a>
      <br /><br />
    </p>

    <div class="panel panel-default">
      <div class="panel-heading"><h3 class="panel-title">Statement List</h3></div>
      <div class="panel-body">

        <table id="statement-list" class="table table-striped table-bordered" cellspacing="0" width="100%">
          <thead>
            <tr>
              <th>Timestamp</th>
              <th>Actor Name</th>
              <th>Verb</th>
              <th>Object Name</th>
              <th>Object Type</th>
              <th>Authority Name</th>
              <th></th>
            </tr>
          </thead>

          <tfoot>
            <tr>
              <th>Timestamp</th>
              <th>Actor Name</th>
              <th>Verb</th>
              <th>Object Name</th>
              <th>Object Type</th>
              <th>Authority Name</th>
              <th></th>
            </tr>
          </tfoot>
        </table>

        <p>
          <a class="btn btn-primary" href="#" role="button" id="more">Get More</a>
        </p>

      </div><!-- .panel-body -->
    </div><!-- .panel -->

	</section>
</body>
</html>
